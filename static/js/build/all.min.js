/* ======================================
 * Title: Guildwars 2 Viz
 * Author: Erik Hazzard (http://vasir.net | erik@visual.ly)
 * ====================================== */
(function(){var a,b=this;a=function(){var a,b,c,d,e;a={},c=function(){return!0},e={capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1)}},b=Modernizr.svgfilters,d=2,$.browser.mozilla&&(d=1);if($.browser.msie||!b)d=0;return{init:c,util:e,data:{},qualityLevel:d,visualizations:{}}}(),window.GW2VIZ=a,a.init=function(){return a.data={gender:[{label:"Male",value:63},{label:"Female",value:37}],race:[{label:"Charr",value:14.32},{label:"Asura",value:15.31},{label:"Sylvari",value:15.31},{label:"Norn",value:20.25},{label:"Human",value:34.81}],profession:[{label:"Engineer",value:10.21},{label:"Mesmer",value:10.21},{label:"Necromancer",value:11.31},{label:"Guardian",value:12.4},{label:"Thief",value:12.4},{label:"Elementalist",value:13.39},{label:"Ranger",value:14.49},{label:"Warrior",value:15.59}],tradeskill:[{label:"Artificer",value:8.2},{label:"Armorsmith",value:10.74},{label:"Huntsman",value:10.74},{label:"Chef",value:13.51},{label:"Jeweler",value:13.51},{label:"Leatherworker",value:13.51},{label:"Tailor",value:13.51},{label:"Weaponsmith",value:16.28}]},a.visualizations.colors={Human:"#a51d11",Norn:"#5dbbb0",Asura:"#6b97c0",Sylvari:"#6e8d4a",Charr:"#9a6d57",Ranger:"#7e8659",Elementalist:"#97bccf",Guardian:"#61b499",Thief:"#701e1e",Necromancer:"#0a3018",Engineer:"#625544",Mesmer:"#975b91",Warrior:"#e09056",Chef:"#527599",Jeweler:"#8e6695",Leatherworker:"#956d58",Tailor:"#a18e46",Armorsmith:"#8e8e8e",Huntsman:"#6e8b54",Artificer:"#6ebeac",Weaponsmith:"#b25252"},a.visualizations.donutViz(),a.visualizations.barViz(),!0}}).call(this),function(){var a=this;GW2VIZ.visualizations.donutViz=function(a){var b,c,d,e,f,g,h,i,j,k,l;return d=GW2VIZ.data,k=d3.select("#svg-el-donut"),b=.94,f=$(document).width(),e=$(document).height(),j=f/1380,j>b&&(j=b),g=k.append("svg:g").attr({id:"donutGroup",transform:"translate("+[0,20]+") scale("+j+")"}),l=k.attr("width"),h=k.attr("height"),f<1200&&k.attr({width:f-parseInt($("#right-content").width(),10)}),i=GW2VIZ.qualityLevel,c=function(a){var b,c,e,f,j,k,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;t=a.labelSize,w=a.radius,s=a.innerRadius||!1,n=a.chartType,B=a.usePiePattern,v=a.pieFill,k=a.callback,j=5,y=0,x=.6,d3.selectAll(".patternRace").attr({width:w,height:w}),m=g.append("svg:g").attr({id:n+"-donut","class":"chartGroup",transform:"translate("+[l/2,h/2]+")"}).data([d[n]]),e=d3.svg.arc().outerRadius(w),s&&e.innerRadius(s),u=d3.layout.pie().value(function(a){return a.value}),f=m.selectAll("g.slice").data(u).enter().append("svg:g").attr("class",function(a,b){return"slice slice"+b}),p=f.append("svg:path").attr("d",e).style({fill:"#ffffff",stroke:"#505050",filter:function(){return i<2?"":"url(#waterColor2)"},"stroke-width":4}),o=f.append("svg:path").attr({d:e,"class":function(a,b){return"edgeSlice"+b}}).style({fill:"#ffffff",stroke:"#707070","stroke-opacity":.6,filter:function(){return i<1?"":"url(#jaggedEdge)"},"stroke-width":1}),f.append("svg:path").attr({d:e,"class":function(a,b){return"slice"+b}}).style({fill:function(a,b){return B===!0?"url(#"+n+a.data.label+"Gradient)":v[b]},stroke:"#343434",filter:function(){return i<1?"":"url(#waterColor1)"},"stroke-width":2,"stroke-opacity":1}),q=f.append("svg:g").attr({"class":function(a,b){return"iconGroup iconGroup"+b}}).style({opacity:x}),r={height:54,width:54},q.append("svg:image").attr({"xlink:href":function(a,b){return"/static/img/viz/"+a.data.label+".png"},x:function(a){return a.innerRadius=0,a.outerRadius=w,e.centroid(a)[0]-r.width/2},y:function(a){return a.innerRadius=0,a.outerRadius=w,e.centroid(a)[1]-r.height/2},width:r.width+"px",height:r.height+"px"}),z=f.append("svg:g").attr({"class":function(a,b){return"textGroup textGroup"+b}}).style({opacity:y}),z.append("svg:text").attr({transform:function(a,b){var c,d;return a.innerRadius=0,a.outerRadius=w,c=e.centroid(a)[0],d=e.centroid(a)[1],a.data.label.length==="Necromancer"&&(c+=8),"translate("+[c,d]+")"},"class":"bgLabel","text-anchor":"middle"}).style({fill:"#ababab",filter:function(){return i<2?"":"url(#waterColor2)"},"font-size":t+j+"px",opacity:.7,"text-shadow":"0 0 1px #000000"}).text(function(a,b){return a.data.label}),z.append("svg:text").attr({transform:function(a,b){var c,d;return a.innerRadius=0,a.outerRadius=w,c=e.centroid(a)[0],d=e.centroid(a)[1],a.data.label==="Necromancer"&&(c+=14),"translate("+[c,d]+")"},"class":"label","text-anchor":"middle"}).style({fill:"#ffffff","font-weight":"bold","font-size":t+"px","text-shadow":"0 0 3px #000000, 0 0 18px #000000"}).text(function(a,b){return a.data.label}),z.append("svg:text").attr({transform:function(a){return a.innerRadius=0,a.outerRadius=w,"translate("+[e.centroid(a)[0],e.centroid(a)[1]+t]+")"},"text-anchor":"middle"}).style({fill:"#ffffff","font-size":"1.1em","text-shadow":"0 0 3px #000000"}).text(function(a,b){return Math.round(a.data.value)+"%"}),c=d3.selectAll(".textGroup"),A=m.selectAll(".textGroup"),b=m.selectAll(".textGroup .label"),i>1&&f.on("mouseover",function(a,b){var d;i>1?m.select(".edgeSlice"+b).transition().duration(300).style({"stroke-width":9,stroke:"#000000","stroke-opacity":.8}):m.select(".edgeSlice"+b).style({"stroke-width":9,stroke:"#000000","stroke-opacity":1}),c.style({opacity:y}),A.style({opacity:.9}),d=m.selectAll(".textGroup"+b),d.style({opacity:1}),d.selectAll(".label").style({"font-size":t+6}),d.selectAll(".bgLabel").style({"font-size":t+j+6}).attr({transform:function(a,b){return"translate("+e.centroid(a)+") rotate("+(18+b*3)+")"}}),i>1&&q.style({opacity:.3});if(n!=="gender")return GW2VIZ.visualizations.barHighlightOver({chartType:n,d:a,i:b})}).on("mouseout",function(a,c){i>1?m.select(".edgeSlice"+c).transition().duration(300).style({"stroke-width":1,stroke:"#707070","stroke-opacity":.6}):m.select(".edgeSlice"+c).transition().duration(300).style({"stroke-width":1,stroke:"#707070","stroke-opacity":.6}),b.style({"font-size":t}),m.selectAll(".textGroup"+c+" .bgLabel").attr({transform:function(a,b){return"translate("+e.centroid(a)+") rotate(0)"}}).style({"font-size":t+j}),A.style({opacity:y}),i>1&&q.style({opacity:x});if(n!=="gender")return GW2VIZ.visualizations.barHighlightOut({chartType:n,d:a,i:c})});if(k)return k()},c({labelSize:14,radius:68,chartType:"gender",usePiePattern:!0}),c({labelSize:17,radius:160,innerRadius:70,chartType:"race",usePiePattern:!0}),c({labelSize:16,radius:270,innerRadius:162,chartType:"profession",usePiePattern:!0}),c({labelSize:17,radius:350,innerRadius:272,chartType:"tradeskill",usePiePattern:!0,callback:function(){return $("#loading").css({opacity:0,display:"none"})}})}}.call(this),function(){var a=this;GW2VIZ.visualizations.barHighlightOver=function(a){var b,c,d,e,f,g,h,i,j;return d=a.chartType,e=a.d,f=a.i,e.data?(g=e.data.label,j=e.data.value):(g=e.label,j=e.value),c=d3.select("#barWrapper-"+d+"-"+g),c.select(".bar").style({opacity:.7}),b=c.select(".barFilter").attr("class"),h=parseInt(b.match(/posX[0-9]+/)[0].replace(/posX/,"")),i=parseInt(b.match(/posY[0-9]+/)[0].replace(/posY/,"")),c.select(".barFilter").attr({x:h,y:i}),$("#"+d+"-meta").html('<img src="/static/img/viz/'+g+'.png" height=28 width=28 /> '+'<span class="label">'+g+'</span> <span class="value">'+j+"%</span>"),!0},GW2VIZ.visualizations.barHighlightOut=function(a){var b,c,d,e;return b=a.chartType,c=a.d,d=a.i,c.data?e=c.data.label:e=c.label,d3.select("#barWrapper-"+b+"-"+e+" .barFilter").attr({x:-5e3,y:-5e3}),$("#"+b+"-meta").html("")},GW2VIZ.visualizations.barViz=function(a){var b;return b=GW2VIZ.visualizations.barCreateChart,b({chartType:"profession"}),b({chartType:"tradeskill"}),b({chartType:"race"})},GW2VIZ.visualizations.barCreateChart=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;return i=a.chartType,j=GW2VIZ.visualizations.colors,t=d3.select("#svg-el-"+i),v=t.attr("width"),r=t.attr("height"),p=$(document).width(),p<1220&&(v=p-(parseInt($("#left-content").width(),10)+30),t.attr({width:v})),o=$(document).height(),o<600&&(r=70,t.attr({height:r})),x=t.append("svg:g").attr({"class":"axisGroup"}),h=t.append("svg:g").attr({"class":"barWrapper"}),k=GW2VIZ.data[i],s={top:10,right:10,bottom:0,left:34},b=v-s.left-s.right,d=8,e=0,f=10,n=_.max(k,function(a){return a.value}).value,n+=4,w=d3.scale.linear().range([s.left+f,v]).domain([0,k.length]),z=d3.scale.linear().range([0,r-s.top-s.bottom]).domain([0,n]),l=h.selectAll("g.chartBars").data(k),l.enter().append("svg:g").attr({"class":"chartBars"}),l.exit().remove(),m=l.selectAll("rect.bar").data(k),g=m.enter().append("svg:g").attr({id:function(a,b){return"barWrapper-"+i+"-"+a.label}}),q=g.append("svg:rect").attr({"class":function(a,b){var c,d;return d=parseInt(r-(z(a.value)+20)-s.bottom-s.top),GW2VIZ.qualityLevel<1&&(d+=22),d<1&&(d=1),c=parseInt(w(b))-6,"barFilter posX"+c+" posY"+d},width:b/k.length+8,x:function(a,b){return-5e3},height:function(a,b){return GW2VIZ.qualityLevel<1?z(a.value):z(a.value)+20},y:function(a,b){return-500}}).style({stroke:"#343434","stroke-width":8,filter:function(){return GW2VIZ.qualityLevel<1?"":"url(#waterColor1)"},opacity:1,fill:function(a,b){return"url(#"+i+a.label+"Gradient)"}}),g.append("svg:rect").attr({"class":"bar",id:function(a,b){return"bar-"+i+"-"+a.label},width:b/k.length-d,x:function(a,b){return w(b)},height:function(a,b){return z(a.value)},y:function(a,b){return r-z(a.value)-s.bottom-s.top},rx:e}).style({stroke:"#454545","stroke-width":"3px",filter:function(){return GW2VIZ.qualityLevel<1?"":"url(#jaggedEdge)"},fill:function(a,b){return"url(#"+i+a.label+"Gradient)"}}),g.append("svg:rect").attr({"class":"bar",id:function(a,b){return"bar-"+i+"-"+a.label},width:b/k.length-d,x:function(a,b){return w(b)},height:function(a,b){return z(a.value)},y:function(a,b){return r-z(a.value)-s.bottom-s.top},rx:e}).style({stroke:"#000000","stroke-width":"1px",fill:"none"}),g.append("svg:image").attr({"xlink:href":function(a,b){return"/static/img/viz/"+a.label+".png"},width:b/k.length-d,x:function(a,b){return w(b)},height:function(a,b){return z(a.value)},y:function(a,b){return r-z(a.value)-s.bottom-s.top}}).style({opacity:.8}),m.exit().remove(),g.on("mouseover",function(a,b){return GW2VIZ.visualizations.barHighlightOver({chartType:i,d:a,i:b})}).on("mouseout",function(a,b){return GW2VIZ.visualizations.barHighlightOut({chartType:i,d:a,i:b})}),c=l.selectAll("text").data(k),c.enter().append("svg:text").attr({x:function(a,b){return w(b)+6},y:r-s.bottom-s.top-3}).style({"font-size":".9em",fill:"#f0f0f0","text-shadow":"0 1px 1px #000000"}).text(function(a,b){return Math.round(a.value)+"%"}).on("mouseover",function(a,b){return GW2VIZ.visualizations.barHighlightOver({chartType:i,d:a,i:b})}).on("mouseout",function(a,b){return GW2VIZ.visualizations.barHighlightOut({chartType:i,d:a,i:b})}),u=d3.scale.linear().range([0,r-s.top-s.bottom]).domain([n,0]),y=d3.svg.axis().scale(u).ticks(5).orient("left").tickSize(-v),x.attr("transform","translate("+[s.left,0]+")").classed("yaxis",!0).call(y),x.selectAll("path").style("fill","none").style("stroke","#505050"),x.selectAll("line").style("fill","none").style("stroke","#606060").style("stroke-width",1).style("opacity",.4),x.selectAll("text").style({fill:"#343434","font-size":".6em","text-shadow":"0 0 1px #ffffff"}).text(function(a,b){return a+"%"})}}.call(this);